// Configuración
const SPREADSHEET_ID = '1eF9n-PCBluNMFO1VE1evSx5NK2612IRSn2_8HPAzUPI';
const TIMEZONE = 'America/Lima';

// Función para obtener datos del spreadsheet
function getSheetData(sheetName, range) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName(sheetName);
    
    if (!sheet) {
      console.error(`Hoja "${sheetName}" no encontrada`);
      return [];
    }
    
    const data = sheet.getRange(range).getValues();
    return data.filter(row => row[0] !== ''); // Filtrar filas vacías
  } catch (error) {
    console.error(`Error obteniendo datos de ${sheetName}:`, error);
    return [];
  }
}

// Función para crear el formulario HTML
function doGet() {
  return HtmlService.createTemplateFromFile('Index')
    .evaluate()
    .setTitle('Formulario de Indicadores')
    .addMetaTag('viewport', 'width=device-width, initial-scale=1')
    .setFaviconUrl('https://www.gstatic.com/images/icons/material/system/1x/assessment_black_24dp.png');
}

// Función para incluir archivos CSS/JS
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

// Obtener datos para los dropdowns
function getDropdownData() {
  const data = {
    años: getSheetData('tiempo', 'A2:A1000').map(row => row[0]),
    meses: getSheetData('tiempo', 'B2:B1000').map(row => row[0]),
    clientes: getSheetData('cuenta', 'A2:A1000').map(row => row[0]),
    responsables: getSheetData('cuenta', 'C2:C1000').map(row => row[0]),
    indicadores: getSheetData('indicador', 'A2:B1000').map(row => ({
      nombre: row[0],
      formato: row[1] || ''
    }))
  };
  
  // Eliminar duplicados
  data.años = [...new Set(data.años)];
  data.meses = [...new Set(data.meses)];
  data.clientes = [...new Set(data.clientes)];
  data.responsables = [...new Set(data.responsables)];
  
  return data;
}

// Obtener campañas según cliente seleccionado
function getCampañasPorCliente(cliente) {
  const data = getSheetData('cuenta', 'A2:B1000');
  const campañas = [];
  
  data.forEach(row => {
    if (row[0] === cliente && row[1] && !campañas.includes(row[1])) {
      campañas.push(row[1]);
    }
  });
  
  return campañas;
}

// Guardar los datos en la hoja base_datos
function guardarDatos(formData) {
  try {
    const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    const sheet = ss.getSheetByName('base_datos');
    
    if (!sheet) {
      throw new Error('Hoja "base_datos" no encontrada');
    }
    
    // Obtener la última fila con datos
    const lastRow = sheet.getLastRow();
    const newRow = lastRow === 0 ? 2 : lastRow + 1;
    
    // Obtener fecha y hora actual en zona horaria Lima/Bogotá
    const ahora = Utilities.formatDate(new Date(), TIMEZONE, 'dd/MM/yyyy HH:mm:ss');
    
    // Preparar datos para insertar
    const rowData = [
      formData.año,
      formData.mes,
      formData.cliente,
      formData.campaña,
      formData.responsable,
      formData.indicador,
      formData.valor,
      formData.comentarios || '',
      ahora // Fecha y hora de registro
    ];
    
    // Insertar datos
    sheet.getRange(newRow, 1, 1, rowData.length).setValues([rowData]);
    
    return {
      success: true,
      message: 'Datos guardados exitosamente'
    };
    
  } catch (error) {
    console.error('Error guardando datos:', error);
    return {
      success: false,
      message: `Error: ${error.toString()}`
    };
  }
}






<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <?!= include('Styles'); ?>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <i class="fas fa-chart-line icon-title"></i>
        <h1>Formulario de Indicadores</h1>
      </div>
      <p class="subtitle">Sistema de registro de métricas y KPIs</p>
    </div>
    
    <form id="mainForm">
      <div class="form-grid">
        <!-- Año -->
        <div class="form-group">
          <label for="anio">
            <i class="fas fa-calendar-alt icon"></i> Año *
          </label>
          <select id="anio" name="anio" required class="form-control">
            <option value="">Seleccionar año...</option>
          </select>
          <div class="form-hint">Seleccione el año del registro</div>
        </div>
        
        <!-- Mes -->
        <div class="form-group">
          <label for="mes">
            <i class="fas fa-calendar icon"></i> Mes *
          </label>
          <select id="mes" name="mes" required class="form-control">
            <option value="">Seleccionar mes...</option>
          </select>
          <div class="form-hint">Seleccione el mes del registro</div>
        </div>
        
        <!-- Cliente -->
        <div class="form-group">
          <label for="cliente">
            <i class="fas fa-building icon"></i> Cliente *
          </label>
          <select id="cliente" name="cliente" required class="form-control">
            <option value="">Seleccionar cliente...</option>
          </select>
          <div class="form-hint">Seleccione el cliente</div>
        </div>
        
        <!-- Campaña -->
        <div class="form-group">
          <label for="campana">
            <i class="fas fa-bullhorn icon"></i> Campaña *
          </label>
          <select id="campana" name="campana" required class="form-control" disabled>
            <option value="">Primero seleccione un cliente</option>
          </select>
          <div class="form-hint">Las campañas dependen del cliente seleccionado</div>
        </div>
        
        <!-- Responsable -->
        <div class="form-group">
          <label for="responsable">
            <i class="fas fa-user-tie icon"></i> Responsable *
          </label>
          <select id="responsable" name="responsable" required class="form-control">
            <option value="">Seleccionar responsable...</option>
          </select>
          <div class="form-hint">Seleccione la persona responsable</div>
        </div>
        
        <!-- Indicador -->
        <div class="form-group">
          <label for="indicador">
            <i class="fas fa-chart-bar icon"></i> Indicador *
          </label>
          <select id="indicador" name="indicador" required class="form-control">
            <option value="">Seleccionar indicador...</option>
          </select>
          <div class="form-hint">Seleccione el tipo de indicador</div>
        </div>
        
        <!-- Valor -->
        <div class="form-group">
          <label for="valor">
            <i class="fas fa-hashtag icon"></i> Valor *
          </label>
          <input type="text" id="valor" name="valor" required class="form-control" placeholder="Ingrese el valor">
          <div class="form-hint" id="valor-hint">El formato depende del indicador seleccionado</div>
        </div>
        
        <!-- Comentarios -->
        <div class="form-group full-width">
          <label for="comentarios">
            <i class="fas fa-comment-dots icon"></i> Comentarios
          </label>
          <textarea id="comentarios" name="comentarios" class="form-control" rows="4" 
                    placeholder="Ingrese comentarios adicionales (máximo 50000 caracteres)"></textarea>
          <div class="form-hint">Máximo 50000 caracteres (límite de celda Google Sheets)</div>
          <div class="char-counter">Caracteres: <span id="charCount">0</span>/50000</div>
        </div>
      </div>
      
      <div class="form-actions">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save"></i> Guardar Registro
        </button>
        <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">
          <i class="fas fa-eraser"></i> Limpiar
        </button>
      </div>
      
      <div id="message" class="message"></div>
    </form>
    
    <div class="footer">
      <p><i class="fas fa-info-circle"></i> Todos los campos marcados con * son obligatorios</p>
      <p class="timestamp">Fecha/Hora: <span id="currentTime"></span></p>
    </div>
  </div>
  
  <?!= include('JavaScript'); ?>
</body>
</html>


















<style>
  :root {
    --azul-primario: #1a237e;
    --azul-secundario: #283593;
    --azul-terciario: #3949ab;
    --azul-claro: #e8eaf6;
    --rojo-primario: #c62828;
    --rojo-secundario: #d32f2f;
    --gris-claro: #f5f5f5;
    --gris-medio: #9e9e9e;
    --gris-oscuro: #424242;
    --blanco: #ffffff;
    --sombra: 0 4px 6px rgba(0, 0, 0, 0.1);
  }
  
  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  
  body {
    background: linear-gradient(135deg, var(--azul-claro) 0%, #f0f2f5 100%);
    min-height: 100vh;
    padding: 20px;
  }
  
  .container {
    max-width: 1200px;
    margin: 0 auto;
    background: var(--blanco);
    border-radius: 12px;
    box-shadow: var(--sombra);
    overflow: hidden;
  }
  
  .header {
    background: linear-gradient(135deg, var(--azul-primario) 0%, var(--azul-terciario) 100%);
    color: var(--blanco);
    padding: 30px;
    text-align: center;
  }
  
  .logo {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 10px;
  }
  
  .icon-title {
    font-size: 2.5rem;
    color: var(--blanco);
  }
  
  h1 {
    font-size: 2.2rem;
    font-weight: 600;
  }
  
  .subtitle {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-top: 5px;
  }
  
  .form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    padding: 30px;
  }
  
  .form-group {
    margin-bottom: 15px;
  }
  
  .form-group.full-width {
    grid-column: 1 / -1;
  }
  
  label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--azul-secundario);
    font-size: 1rem;
  }
  
  .icon {
    color: var(--azul-terciario);
    margin-right: 8px;
    width: 20px;
  }
  
  .form-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #ddd;
    border-radius: 8px;
    font-size: 1rem;
    transition: all 0.3s ease;
    background-color: var(--blanco);
  }
  
  .form-control:focus {
    outline: none;
    border-color: var(--azul-terciario);
    box-shadow: 0 0 0 3px rgba(57, 73, 171, 0.1);
  }
  
  .form-control:disabled {
    background-color: #f9f9f9;
    cursor: not-allowed;
  }
  
  select.form-control {
    appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%233945ab' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 20px;
    padding-right: 45px;
  }
  
  textarea.form-control {
    resize: vertical;
    min-height: 100px;
  }
  
  .form-hint {
    font-size: 0.85rem;
    color: var(--gris-medio);
    margin-top: 5px;
    font-style: italic;
  }
  
  .char-counter {
    text-align: right;
    font-size: 0.85rem;
    color: var(--gris-medio);
    margin-top: 5px;
  }
  
  .form-actions {
    display: flex;
    justify-content: center;
    gap: 20px;
    padding: 20px 30px;
    border-top: 1px solid #eee;
  }
  
  .btn {
    padding: 14px 30px;
    border: none;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    min-width: 200px;
  }
  
  .btn-primary {
    background: linear-gradient(135deg, var(--rojo-secundario) 0%, var(--rojo-primario) 100%);
    color: var(--blanco);
  }
  
  .btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(198, 40, 40, 0.2);
  }
  
  .btn-secondary {
    background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
    color: var(--gris-oscuro);
    border: 1px solid #ddd;
  }
  
  .btn-secondary:hover {
    background: linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%);
  }
  
  .message {
    margin: 0 30px 20px;
    padding: 15px;
    border-radius: 8px;
    text-align: center;
    display: none;
  }
  
  .message.success {
    background-color: #e8f5e9;
    color: #2e7d32;
    border: 1px solid #c8e6c9;
    display: block;
  }
  
  .message.error {
    background-color: #ffebee;
    color: #c62828;
    border: 1px solid #ffcdd2;
    display: block;
  }
  
  .footer {
    background-color: var(--azul-claro);
    padding: 20px 30px;
    text-align: center;
    border-top: 1px solid #ddd;
    color: var(--azul-secundario);
  }
  
  .footer p {
    margin: 5px 0;
  }
  
  .timestamp {
    font-weight: 600;
    color: var(--rojo-primario);
  }
  
  @media (max-width: 768px) {
    .form-grid {
      grid-template-columns: 1fr;
      padding: 20px;
    }
    
    .form-actions {
      flex-direction: column;
      align-items: center;
    }
    
    .btn {
      width: 100%;
      max-width: 300px;
    }
    
    .header {
      padding: 20px;
    }
    
    h1 {
      font-size: 1.8rem;
    }
  }
  
  /* Estilos para validación */
  .error-input {
    border-color: var(--rojo-secundario) !important;
  }
  
  .success-input {
    border-color: #4caf50 !important;
  }
</style>















<script>
  // Variables globales
  let indicadoresData = [];
  let valorFormat = '';
  
  // Cargar datos cuando se carga la página
  document.addEventListener('DOMContentLoaded', function() {
    cargarDatosIniciales();
    actualizarHora();
    setInterval(actualizarHora, 1000);
    
    // Event listener para el contador de caracteres
    document.getElementById('comentarios').addEventListener('input', function() {
      document.getElementById('charCount').textContent = this.value.length;
    });
    
    // Event listener para cambio de cliente
    document.getElementById('cliente').addEventListener('change', function() {
      actualizarCampañas(this.value);
    });
    
    // Event listener para cambio de indicador
    document.getElementById('indicador').addEventListener('change', function() {
      actualizarFormatoValor(this.value);
    });
    
    // Event listener para validación del valor
    document.getElementById('valor').addEventListener('input', function() {
      validarValor(this.value);
    });
    
    // Event listener para el formulario
    document.getElementById('mainForm').addEventListener('submit', function(e) {
      e.preventDefault();
      enviarFormulario();
    });
  });
  
  // Cargar datos iniciales de los dropdowns
  function cargarDatosIniciales() {
    google.script.run
      .withSuccessHandler(function(data) {
        // Llenar año
        const selectAnio = document.getElementById('anio');
        data.años.forEach(año => {
          const option = document.createElement('option');
          option.value = año;
          option.textContent = año;
          selectAnio.appendChild(option);
        });
        
        // Llenar mes
        const selectMes = document.getElementById('mes');
        data.meses.forEach(mes => {
          const option = document.createElement('option');
          option.value = mes;
          option.textContent = mes;
          selectMes.appendChild(option);
        });
        
        // Llenar cliente
        const selectCliente = document.getElementById('cliente');
        data.clientes.forEach(cliente => {
          const option = document.createElement('option');
          option.value = cliente;
          option.textContent = cliente;
          selectCliente.appendChild(option);
        });
        
        // Llenar responsable
        const selectResponsable = document.getElementById('responsable');
        data.responsables.forEach(responsable => {
          const option = document.createElement('option');
          option.value = responsable;
          option.textContent = responsable;
          selectResponsable.appendChild(option);
        });
        
        // Llenar indicador y guardar datos de formato
        const selectIndicador = document.getElementById('indicador');
        indicadoresData = data.indicadores;
        
        data.indicadores.forEach(indicador => {
          if (indicador.nombre) {
            const option = document.createElement('option');
            option.value = indicador.nombre;
            option.textContent = indicador.nombre;
            option.setAttribute('data-formato', indicador.formato || '');
            selectIndicador.appendChild(option);
          }
        });
        
        mostrarMensaje('Datos cargados correctamente', 'success');
      })
      .withFailureHandler(function(error) {
        mostrarMensaje('Error cargando datos: ' + error, 'error');
      })
      .getDropdownData();
  }
  
  // Actualizar campañas según cliente seleccionado
  function actualizarCampañas(cliente) {
    const selectCampana = document.getElementById('campana');
    
    if (!cliente) {
      selectCampana.innerHTML = '<option value="">Primero seleccione un cliente</option>';
      selectCampana.disabled = true;
      return;
    }
    
    selectCampana.innerHTML = '<option value="">Cargando campañas...</option>';
    selectCampana.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(campañas) {
        selectCampana.innerHTML = '';
        
        if (campañas.length === 0) {
          const option = document.createElement('option');
          option.value = '';
          option.textContent = 'No hay campañas para este cliente';
          selectCampana.appendChild(option);
        } else {
          const defaultOption = document.createElement('option');
          defaultOption.value = '';
          defaultOption.textContent = 'Seleccionar campaña...';
          selectCampana.appendChild(defaultOption);
          
          campañas.forEach(campaña => {
            const option = document.createElement('option');
            option.value = campaña;
            option.textContent = campaña;
            selectCampana.appendChild(option);
          });
        }
        
        selectCampana.disabled = false;
      })
      .withFailureHandler(function(error) {
        selectCampana.innerHTML = '<option value="">Error cargando campañas</option>';
        mostrarMensaje('Error cargando campañas: ' + error, 'error');
      })
      .getCampañasPorCliente(cliente);
  }
  
  // Actualizar formato del campo valor según indicador
  function actualizarFormatoValor(indicadorSeleccionado) {
    const inputValor = document.getElementById('valor');
    const valorHint = document.getElementById('valor-hint');
    
    // Buscar el formato del indicador seleccionado
    const indicador = indicadoresData.find(ind => ind.nombre === indicadorSeleccionado);
    
    if (indicador && indicador.formato) {
      valorFormat = indicador.formato.toLowerCase();
      inputValor.placeholder = 'Ingrese el valor (' + indicador.formato + ')';
      
      if (valorFormat.includes('porcentaje') || valorFormat.includes('%')) {
        valorHint.textContent = 'Porcentaje (valores entre 0 y 1, ej: 0.85 para 85%)';
        inputValor.type = 'number';
        inputValor.step = '0.01';
        inputValor.min = '0';
        inputValor.max = '1';
      } else if (valorFormat.includes('entero') || valorFormat.includes('número entero')) {
        valorHint.textContent = 'Número entero (sin decimales)';
        inputValor.type = 'number';
        inputValor.step = '1';
      } else if (valorFormat.includes('decimal') || valorFormat.includes('número')) {
        valorHint.textContent = 'Número decimal';
        inputValor.type = 'number';
        inputValor.step = '0.01';
      } else {
        valorHint.textContent = 'El formato depende del indicador seleccionado';
        inputValor.type = 'text';
      }
    } else {
      valorHint.textContent = 'El formato depende del indicador seleccionado';
      inputValor.type = 'text';
      valorFormat = '';
    }
    
    // Limpiar y validar el valor actual
    inputValor.value = '';
    inputValor.classList.remove('error-input', 'success-input');
  }
  
  // Validar el valor según el formato
  function validarValor(valor) {
    const inputValor = document.getElementById('valor');
    
    if (!valor || !valorFormat) {
      inputValor.classList.remove('error-input', 'success-input');
      return;
    }
    
    // Validar según el formato
    let esValido = false;
    
    if (valorFormat.includes('porcentaje') || valorFormat.includes('%')) {
      const num = parseFloat(valor);
      esValido = !isNaN(num) && num >= 0 && num <= 1;
    } else if (valorFormat.includes('entero')) {
      const num = parseInt(valor);
      esValido = !isNaN(num) && Number.isInteger(num) && valor === num.toString();
    } else if (valorFormat.includes('decimal') || valorFormat.includes('número')) {
      const num = parseFloat(valor);
      esValido = !isNaN(num);
    } else {
      // Para otros formatos, aceptar cualquier valor
      esValido = true;
    }
    
    if (esValido) {
      inputValor.classList.remove('error-input');
      inputValor.classList.add('success-input');
    } else {
      inputValor.classList.remove('success-input');
      inputValor.classList.add('error-input');
    }
  }
  
  // Enviar formulario
  function enviarFormulario() {
    const form = document.getElementById('mainForm');
    const formData = {
      año: document.getElementById('anio').value,
      mes: document.getElementById('mes').value,
      cliente: document.getElementById('cliente').value,
      campaña: document.getElementById('campana').value,
      responsable: document.getElementById('responsable').value,
      indicador: document.getElementById('indicador').value,
      valor: document.getElementById('valor').value,
      comentarios: document.getElementById('comentarios').value.substring(0, 50000) // Limitar a 50000 caracteres
    };
    
    // Validar el valor antes de enviar
    if (!validarValorAntesDeEnviar(formData.valor)) {
      mostrarMensaje('El valor ingresado no cumple con el formato requerido para el indicador seleccionado.', 'error');
      return;
    }
    
    // Mostrar indicador de carga
    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Guardando...';
    submitBtn.disabled = true;
    
    google.script.run
      .withSuccessHandler(function(result) {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        
        if (result.success) {
          mostrarMensaje(result.message, 'success');
          limpiarFormulario();
          // Desplazar al inicio del formulario
          window.scrollTo({ top: 0, behavior: 'smooth' });
        } else {
          mostrarMensaje(result.message, 'error');
        }
      })
      .withFailureHandler(function(error) {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
        mostrarMensaje('Error: ' + error.toString(), 'error');
      })
      .guardarDatos(formData);
  }
  
  // Validación final del valor antes de enviar
  function validarValorAntesDeEnviar(valor) {
    if (!valorFormat) return true;
    
    if (valorFormat.includes('porcentaje') || valorFormat.includes('%')) {
      const num = parseFloat(valor);
      return !isNaN(num) && num >= 0 && num <= 1;
    } else if (valorFormat.includes('entero')) {
      const num = parseInt(valor);
      return !isNaN(num) && Number.isInteger(num) && valor === num.toString();
    } else if (valorFormat.includes('decimal') || valorFormat.includes('número')) {
      const num = parseFloat(valor);
      return !isNaN(num);
    }
    
    return true;
  }
  
  // Limpiar formulario
  function limpiarFormulario() {
    document.getElementById('mainForm').reset();
    document.getElementById('campana').innerHTML = '<option value="">Primero seleccione un cliente</option>';
    document.getElementById('campana').disabled = true;
    document.getElementById('valor-hint').textContent = 'El formato depende del indicador seleccionado';
    document.getElementById('valor').type = 'text';
    document.getElementById('valor').placeholder = 'Ingrese el valor';
    document.getElementById('valor').classList.remove('error-input', 'success-input');
    document.getElementById('charCount').textContent = '0';
    document.getElementById('message').style.display = 'none';
    valorFormat = '';
  }
  
  // Mostrar mensajes
  function mostrarMensaje(texto, tipo) {
    const messageDiv = document.getElementById('message');
    messageDiv.textContent = texto;
    messageDiv.className = 'message ' + tipo;
    messageDiv.style.display = 'block';
    
    // Ocultar mensaje después de 5 segundos
    setTimeout(function() {
      messageDiv.style.display = 'none';
    }, 5000);
  }
  
  // Actualizar hora actual
  function actualizarHora() {
    const now = new Date();
    const options = { 
      timeZone: 'America/Lima',
      weekday: 'long',
      year: 'numeric', 
      month: 'long', 
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    };
    
    const formatter = new Intl.DateTimeFormat('es-ES', options);
    document.getElementById('currentTime').textContent = formatter.format(now);
  }
</script>












