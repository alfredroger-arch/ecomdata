// Configuraci√≥n
var SHEET_ID = '1CO5DzvDk61oeqYA-Ba4jtopPYZ_xN_jOj7EYY145bJw';
var SHEET_NAME = 'BASE';
var DRIVE_FOLDER_ID = '1U9sZ3bOx3ikHdZx2ourY-20PDIfsy1nY'; // Tu carpeta Drive
var MAX_FILE_SIZE = 20 * 1024 * 1024; // 20MB en bytes

// FUNCI√ìN PRINCIPAL - Acepta par√°metros de URL
function doGet(e) {
  console.log('=== FORMULARIO EJECUTADO ===');
  
  // Obtener par√°metros de la URL
  var params = e ? e.parameter : {};
  
  // Crear objeto con todos los par√°metros prellenados
  var prefillData = {
    dni: params.DNI || params.dni || '',
    fecha: params.Fecha || params.fecha || '',
    asiste: params.Asiste || '',
    nombres_apellidos: params.NOMBRES_APELLIDOS || '',
    supervisor: params.SUPERVISOR_OPERACIONES || '',
    cargo: params.CARGO || '',
    camp: params.CAMP || '',
    t_trabajo: params.T_TRABAJO || '',
    codigo_id: params.CODIGO_ID || '',
    compensado: params.Compensado || '',
    fecha_compensado: params.Fecha_compensado || ''
  };
  
  console.log('Datos recibidos:', prefillData);
  
  // Pasar par√°metros al HTML
  var template = HtmlService.createTemplateFromFile('Formulario');
  
  // Asignar todos los datos al template
  template.dni = prefillData.dni;
  template.fecha = prefillData.fecha;
  template.asiste = prefillData.asiste;
  template.nombres_apellidos = prefillData.nombres_apellidos;
  template.supervisor = prefillData.supervisor;
  template.cargo = prefillData.cargo;
  template.camp = prefillData.camp;
  template.t_trabajo = prefillData.t_trabajo;
  template.codigo_id = prefillData.codigo_id;
  template.compensado = prefillData.compensado;
  template.fecha_compensado = prefillData.fecha_compensado;
  
  return template.evaluate()
    .setTitle('Registro de Asistencia')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
}

// Funci√≥n para procesar los datos
function procesarDatos(data) {
  console.log('=== PROCESANDO DATOS ===');
  console.log('Timestamp:', new Date().toISOString());
  console.log('Datos recibidos keys:', Object.keys(data));
  
  try {
    // Validar que el DNI no est√© vac√≠o
    if (!data || !data.dni || data.dni.toString().trim() === '') {
      console.error('‚ùå Error: DNI vac√≠o');
      return { 
        success: false, 
        message: 'El DNI es requerido' 
      };
    }
    
    var dni = data.dni.toString().trim();
    var archivoUrl = '';
    var archivoNombre = '';
    var archivoId = '';
    var archivoSubido = false;
    
    // Procesar archivo si existe
    if (data.archivoBase64 && data.archivoNombre && data.codigo_id && data.codigo_id.toString().trim() !== '') {
      console.log('‚úÖ Subiendo archivo a Drive...');
      
      var uploadResult = subirArchivoDrive(
        data.archivoBase64, 
        data.archivoNombre, 
        data.archivoTipo,
        data.codigo_id.toString().trim()
      );
      
      console.log('Resultado de subida:', uploadResult);
      
      if (uploadResult.success) {
        archivoUrl = uploadResult.url;
        archivoNombre = uploadResult.nombre;
        archivoId = uploadResult.id;
        archivoSubido = true;
        console.log('‚úÖ Archivo subido exitosamente:', archivoNombre);
      } else {
        console.warn('‚ùå Error subiendo archivo:', uploadResult.message);
      }
    } else {
      console.log('‚ÑπÔ∏è No se subir√° archivo (no cumple condiciones)');
    }
    
    // Conectar con Google Sheets
    var spreadsheet = SpreadsheetApp.openById(SHEET_ID);
    var sheet = spreadsheet.getSheetByName(SHEET_NAME);
    
    if (!sheet) {
      console.error('‚ùå Error: No se encontr√≥ la hoja:', SHEET_NAME);
      return { 
        success: false, 
        message: 'No se encontr√≥ la hoja de destino' 
      };
    }
    
    // Obtener la √∫ltima fila con datos
    var ultimaFila = sheet.getLastRow();
    var filaDestino = Math.max(ultimaFila + 1, 2);
    
    console.log('üìù Guardando en fila:', filaDestino);
    
    // Preparar datos para guardar (19 columnas)
    var datosFila = [
      dni, // Columna A: DNI
      data.fecha || '', // Columna B: Fecha
      '', // Columna C: Entrada (removido)
      '', // Columna D: Salida (removido)
      data.asiste || '', // Columna E: Asiste
      data.nombres_apellidos || '', // Columna F: NOMBRES APELLIDOS
      data.supervisor || '', // Columna G: SUPERVISOR OPERACIONES
      data.cargo || '', // Columna H: CARGO
      data.camp || '', // Columna I: CAMP
      data.t_trabajo || '', // Columna J: T_TRABAJO
      data.codigo_id || '', // Columna K: CODIGO_ID
      data.compensado || '', // Columna L: Compensado
      data.fecha_compensado || '', // Columna M: Fecha compensado
      data.observaciones || '', // Columna N: Observaciones
      new Date(), // Columna O: Fecha de registro
      data.source || 'formulario', // Columna P: Origen
      Session.getActiveUser().getEmail() || 'anonimo@dominio.com', // Columna Q: Usuario
      archivoUrl, // Columna R: URL del archivo
      archivoNombre // Columna S: Nombre del archivo
    ];
    
    // Guardar en una sola operaci√≥n
    sheet.getRange(filaDestino, 1, 1, datosFila.length).setValues([datosFila]);
    
    // Formato de celdas
    if (data.fecha) sheet.getRange(filaDestino, 2).setNumberFormat('yyyy-mm-dd');
    if (data.fecha_compensado) sheet.getRange(filaDestino, 13).setNumberFormat('yyyy-mm-dd');
    sheet.getRange(filaDestino, 15).setNumberFormat('yyyy-mm-dd hh:mm:ss');
    
    // Si hay archivo, hacer hiperv√≠nculo en columna R
    if (archivoUrl) {
      var formula = '=HYPERLINK("' + archivoUrl + '", "üìé Ver archivo")';
      sheet.getRange(filaDestino, 18).setFormula(formula);
      sheet.getRange(filaDestino, 18).setFontColor('#1155cc');
      sheet.getRange(filaDestino, 18).setFontWeight('bold');
    }
    
    console.log('‚úÖ Datos guardados exitosamente en fila:', filaDestino);
    
    return { 
      success: true, 
      message: 'Registro guardado exitosamente' + (archivoSubido ? ' con archivo adjunto' : ''),
      details: {
        row: filaDestino,
        dni: dni,
        nombre: data.nombres_apellidos || '',
        fecha: new Date().toLocaleDateString('es-ES'),
        archivo: archivoNombre || 'Sin archivo',
        archivoUrl: archivoUrl || '',
        codigo_id: data.codigo_id || '',
        archivoSubido: archivoSubido
      }
    };
    
  } catch (error) {
    console.error('‚ùå Error en procesarDatos:', error);
    return { 
      success: false, 
      message: 'Error al procesar: ' + error.toString(),
      error: error.message
    };
  }
}

// Funci√≥n para subir archivo a Google Drive - SOLO C√ìDIGO COMO NOMBRE
function subirArchivoDrive(base64Data, fileName, mimeType, codigoID) {
  console.log('=== SUBIENDO ARCHIVO A DRIVE ===');
  console.log('Archivo original:', fileName);
  console.log('C√≥digo ID:', codigoID);
  
  try {
    // Validar que los datos Base64 no est√©n vac√≠os
    if (!base64Data || base64Data.trim() === '' || base64Data === 'undefined') {
      console.error('‚ùå ERROR: Datos Base64 vac√≠os');
      return {
        success: false,
        message: 'Los datos del archivo est√°n vac√≠os'
      };
    }
    
    // Validar tama√±o del archivo (20MB m√°ximo)
    var fileSize = (base64Data.length * 3) / 4;
    if (fileSize > MAX_FILE_SIZE) {
      console.error('‚ùå Error: Archivo excede tama√±o m√°ximo');
      return {
        success: false,
        message: 'El archivo excede el tama√±o m√°ximo de 20MB'
      };
    }
    
    // Convertir Base64 a blob
    var byteCharacters;
    try {
      byteCharacters = Utilities.base64Decode(base64Data);
    } catch (decodeError) {
      console.error('‚ùå Error decodificando Base64:', decodeError.message);
      return {
        success: false,
        message: 'Error en formato Base64: ' + decodeError.message
      };
    }
    
    var blob = Utilities.newBlob(byteCharacters, mimeType, fileName);
    
    // Obtener carpeta destino
    var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    if (!folder) {
      throw new Error('No se encontr√≥ la carpeta destino en Drive');
    }
    
    // CREAR NOMBRE DEL ARCHIVO: SOLO EL C√ìDIGO + EXTENSI√ìN
    var safeCodigo = codigoID.toString().trim();
    
    // Eliminar caracteres inv√°lidos para nombre de archivo
    safeCodigo = safeCodigo.replace(/[\/\\?%*:|"<>]/g, '_');
    
    // Obtener extensi√≥n del archivo original
    var extension = fileName.split('.').pop() || getExtensionFromMimeType(mimeType) || 'bin';
    
    // Crear nombre final: SOLO C√ìDIGO.EXTENSI√ìN
    var newFileName = safeCodigo + '.' + extension;
    
    console.log('Nuevo nombre de archivo (solo c√≥digo):', newFileName);
    
    // Verificar si ya existe un archivo con ese nombre
    var existingFiles = folder.getFilesByName(newFileName);
    if (existingFiles.hasNext()) {
      // Si existe, agregar n√∫mero de versi√≥n
      var version = 1;
      var baseName = safeCodigo;
      
      // Buscar siguiente versi√≥n disponible
      while (folder.getFilesByName(baseName + '_' + version + '.' + extension).hasNext()) {
        version++;
      }
      
      newFileName = baseName + '_' + version + '.' + extension;
      console.log('Archivo ya existe, usando nombre con versi√≥n:', newFileName);
    }
    
    // Subir archivo a Drive
    var file = folder.createFile(blob);
    file.setName(newFileName);
    file.setDescription('Subido desde formulario de asistencia - C√≥digo: ' + codigoID);
    
    // Dar permisos de visualizaci√≥n
    file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
    
    var fileUrl = file.getUrl();
    var fileId = file.getId();
    
    console.log('‚úÖ Archivo subido exitosamente!');
    console.log('üÜî ID:', fileId);
    console.log('üîó URL:', fileUrl);
    
    return {
      success: true,
      url: fileUrl,
      nombre: newFileName,
      id: fileId,
      size: file.getSize(),
      mimeType: file.getMimeType()
    };
    
  } catch (error) {
    console.error('‚ùå Error subiendo archivo a Drive:', error);
    return {
      success: false,
      message: 'Error subiendo archivo: ' + error.message
    };
  }
}

// Funci√≥n para obtener extensi√≥n desde MIME type
function getExtensionFromMimeType(mimeType) {
  const mimeToExt = {
    'application/pdf': 'pdf',
    'image/jpeg': 'jpg',
    'image/png': 'png',
    'image/gif': 'gif',
    'application/msword': 'doc',
    'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
    'application/vnd.ms-excel': 'xls',
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
    'text/plain': 'txt',
    'text/csv': 'csv'
  };
  return mimeToExt[mimeType] || null;
}

// Agrega esta funci√≥n al final de tu Google Script
function verificarDrive() {
  console.log('=== VERIFICACI√ìN DRIVE ===');
  console.log('ID Carpeta:', DRIVE_FOLDER_ID);
  console.log('Fecha:', new Date().toISOString());
  
  try {
    // 1. Intentar acceder a la carpeta
    console.log('1. Accediendo a la carpeta...');
    var folder = DriveApp.getFolderById(DRIVE_FOLDER_ID);
    console.log('‚úÖ Carpeta encontrada:', folder.getName());
    console.log('üîó URL carpeta:', folder.getUrl());
    
    // 2. Verificar permisos de escritura
    console.log('2. Probando permisos de escritura...');
    var testFile = folder.createFile('test_verificacion.txt', 'Archivo de prueba - ' + new Date().toISOString());
    console.log('‚úÖ Archivo de prueba creado:', testFile.getName());
    console.log('üÜî ID archivo:', testFile.getId());
    console.log('üîó URL archivo:', testFile.getUrl());
    
    // 3. Contar archivos existentes
    console.log('3. Contando archivos existentes...');
    var files = folder.getFiles();
    var count = 0;
    while (files.hasNext()) {
      var file = files.next();
      count++;
      if (count <= 3) {
        console.log('   - ' + file.getName() + ' (' + file.getSize() + ' bytes)');
      }
    }
    console.log('üìä Total archivos en carpeta:', count);
    
    // 4. NO eliminar el archivo de prueba - dejarlo como evidencia
    console.log('‚ÑπÔ∏è Archivo de prueba NO eliminado para verificaci√≥n');
    
    return {
      success: true,
      message: '‚úÖ Drive configurado correctamente',
      folder: folder.getName(),
      totalFiles: count,
      testFile: {
        name: testFile.getName(),
        id: testFile.getId(),
        url: testFile.getUrl()
      }
    };
    
  } catch (error) {
    console.error('‚ùå ERROR:', error);
    return {
      success: false,
      message: '‚ùå Error: ' + error.message,
      error: error.toString()
    };
  }
}

// Funci√≥n para verificar Base64
function verificarBase64(data) {
  console.log('=== VERIFICACI√ìN BASE64 ===');
  console.log('Longitud Base64 recibida:', data.length);
  console.log('Primeros 50 chars:', data.substring(0, 50));
  console.log('√öltimos 50 chars:', data.substring(data.length - 50));
  
  try {
    var bytes = Utilities.base64Decode(data);
    console.log('‚úÖ Base64 v√°lido, bytes decodificados:', bytes.length);
    return { success: true, bytes: bytes.length };
  } catch (e) {
    console.error('‚ùå Base64 inv√°lido:', e.message);
    return { success: false, error: e.message };
  }
}
